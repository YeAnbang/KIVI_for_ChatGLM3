new_tokens=96 batch_size=10

# After applied KIVI:

## Model output:
```
#### 624
Question: John takes care of 10 dogs. Each dog takes .5 hours a day to walk and take care of their business. How many hours a week does he spend taking care of dogs?
==========
# prompt tokens: 740, K bit: 2, v_bits: 2, group_size: 32, residual_length: 32
==========
KiVi Output:

Answer: He takes care of 10 dogs * .5 hours = <<10*0.5=5>>5 hours a day.
He takes care of dogs 5 hours a day * 7 days a week = <<5*7=35>>35 hours a week.
#### 35
Question: A group of 10 people are going to a concert. 4 of them are going to drive,
```

## peak memory usage during generation at each iteration:
before prefill
11936.69189453125
prefill
12287.3505859375
generating the fiest token ...
12092.58154296875
12092.85498046875
12093.10107421875
12093.37451171875
12093.62060546875
12093.89404296875
12094.14013671875
12094.41357421875
12094.65966796875
12094.93310546875
12095.17919921875
12095.45263671875
12095.69873046875
12095.97216796875
12096.21826171875
12096.49169921875
12096.73779296875
12097.01123046875
12097.25732421875
12097.53076171875
12097.77685546875
12098.05029296875
12098.29638671875
12098.56982421875
12098.81591796875
12099.08935546875
12099.33544921875
12099.60888671875
12094.1689453125
12094.4423828125
12094.6884765625
12094.9619140625
12095.2080078125
12095.4814453125
12095.7275390625
12096.0009765625
12096.2470703125
12096.5205078125
12096.7666015625
12097.0400390625
12097.2861328125
12097.5595703125
12097.8056640625
12098.0791015625
12098.3251953125
12098.5986328125
12098.8447265625
12099.1181640625
12099.3642578125
12099.6376953125
12099.8837890625
12100.1572265625
12100.4033203125
12100.6767578125
12100.9228515625
12101.1962890625
12101.4423828125
12101.7158203125
12101.9619140625
12102.2353515625
12096.7939453125
12097.0673828125
12097.3134765625
12097.5869140625
12097.8330078125
12098.1064453125
12098.3525390625
12098.6259765625
12098.8720703125
12099.1455078125
12099.3916015625
12099.6650390625
12099.9111328125
12100.1845703125
12100.4306640625
12100.7041015625
12100.9501953125
12101.2236328125
12101.4697265625
12101.7431640625
12101.9892578125
12102.2626953125
12102.5087890625
12102.7822265625
12103.0283203125
12103.3017578125
12103.5478515625
12103.8212890625
12104.0673828125
12104.3408203125
12104.5869140625
12104.8603515625
12099.42041015625
12099.69384765625
12099.93994140625

# Before applied KIVI

## Model output:
```
#### 624
Question: John takes care of 10 dogs. Each dog takes .5 hours a day to walk and take care of their business. How many hours a week does he spend taking care of dogs?
==========
# prompt tokens: 740, K bit: 2, v_bits: 2, group_size: 32, residual_length: 32
==========
KiVi Output:

Answer: He takes care of 10 dogs * .5 hours = <<10*0.5=5>>5 hours a day.
He spends 5 hours a day * 7 days a week = <<5*7=35>>35 hours a week.
#### 35
Question: A group of 10 people are going to a concert. 4 of them are going to drive, 3 of
Peak generation memory: 2976.4453125 MB
```

## peak memory usage during generation: 
11936.69189453125
12243.6376953125
12045.71435546875
12045.74169921875
12045.76904296875
12045.79638671875
12045.82373046875
12045.85107421875
12045.87841796875
12045.90576171875
12045.93310546875
12045.96044921875
12045.98779296875
12046.01513671875
12046.04248046875
12046.06982421875
12046.09716796875
12046.12451171875
12046.15185546875
12046.17919921875
12046.20654296875
12046.23388671875
12046.26123046875
12046.28857421875
12046.31591796875
12046.34326171875
12046.37060546875
12046.39794921875
12046.42529296875
12046.45263671875
12046.4814453125
12046.5087890625
12046.5361328125
12046.5634765625
12046.5908203125
12046.6181640625
12046.6455078125
12046.6728515625
12046.7001953125
12046.7275390625
12046.7548828125
12046.7822265625
12046.8095703125
12046.8369140625
12046.8642578125
12046.8916015625
12046.9189453125
12046.9462890625
12046.9736328125
12047.0009765625
12047.0283203125
12047.0556640625
12047.0830078125
12047.1103515625
12047.1376953125
12047.1650390625
12047.1923828125
12047.2197265625
12047.2470703125
12047.2744140625
12047.3017578125
12047.3291015625
12047.3564453125
12047.3837890625
12047.4111328125
12047.4384765625
12047.4658203125
12047.4931640625
12047.5205078125
12047.5478515625
12047.5751953125
12047.6025390625
12047.6298828125
12047.6572265625
12047.6845703125
12047.7119140625
12047.7392578125
12047.7666015625
12047.7939453125
12047.8212890625
12047.8486328125
12047.8759765625
12047.9033203125
12047.9306640625
12047.9580078125
12047.9853515625
12048.0126953125
12048.0400390625
12048.0673828125
12048.0947265625
12048.1220703125
12048.1494140625
12048.1767578125
12048.2041015625
12048.23291015625
12048.26025390625
12048.28759765625


# Conclusion

ChatGLM3 already applied a technique called Multi-query attention, which dramatically reduces kv-cache memory consumption
from 
key: torch.Size([740, 1, 32, 128]) value: torch.Size([740, 1, 32, 128]) total: torch.Size([1, 2, 740, 1, 32, 128])
to 
key: torch.Size([740, 1, 2, 128]) value: torch.Size([740, 1, 2, 128]) total: torch.Size([1, 2, 740, 1, 2, 128])
kv_cache_size = 0.72265625MB

which is better than KIVI, the later needs to cache the following vectors
torch.Size([1, 32, 128, 46]) torch.Size([1, 32, 4, 128]) torch.Size([1, 32, 128, 23]) torch.Size([1, 32, 128, 23]) torch.Size([1, 32, 708, 8]) torch.Size([1, 32, 32, 128]) torch.Size([1, 32, 708, 4]) torch.Size([1, 32, 708, 4])
of type:
torch.int32 torch.float16 torch.float16 torch.float16 torch.int32 torch.float16 torch.float16 torch.float16
which takes 1.2 MB

I don't think apply KIVI to ChatGLM 3 is a good idea.